================================================================================
                            AVITO RENTAL BOT
                              Автор: ZerX
================================================================================

Автоматический бот для работы с арендой недвижимости на Avito.
Мониторит новые сообщения от потенциальных арендаторов, собирает необходимую
информацию о клиентах и отправляет заявки в Telegram.

--------------------------------------------------------------------------------
ВОЗМОЖНОСТИ
--------------------------------------------------------------------------------

* Автоматический мониторинг новых сообщений на Avito
* Интеллектуальное общение с клиентами через GPT-4
* Сбор полной информации о потенциальных арендаторов
* Отправка структурированных заявок в Telegram
* Многопоточная обработка нескольких чатов одновременно
* Работа в режиме 24/7 на сервере

--------------------------------------------------------------------------------
СТРУКТУРА ПРОЕКТА
--------------------------------------------------------------------------------

avito-rental-bot/
├── main.py          Главный файл запуска с логикой AvitoRentalBot
├── avito.py         Работа с Avito API (AvitoClient)
├── chat_gpt.py      Взаимодействие с OpenAI (ChatGPTHandler)
├── telegram.py      Отправка уведомлений в Telegram (TelegramBot)
├── config.py        Настройки, промпты и конфигурация
├── deploy.sh        Скрипт развертывания на сервере
└── README.md        Документация проекта

--------------------------------------------------------------------------------
ПРИНЦИП РАБОТЫ
--------------------------------------------------------------------------------

[1] Бот каждые 5 секунд проверяет новые сообщения на Avito
[2] Отвечает только на сообщения, полученные не позднее 3 часов назад
[3] Через GPT-4o-mini ведет диалог с клиентом, собирая необходимую информацию:
    - Состав жильцов (возраст, пол каждого взрослого)
    - Наличие детей и животных с конкретными деталями
    - Срок аренды (от скольки месяцев)
    - Дата заселения (конкретное число и месяц)
    - Имя клиента
    - Номер телефона
[4] После сбора всей информации отправляет заявку в Telegram
[5] Каждый клиент обрабатывается в отдельном контексте
[6] Использует детальные промпты для профессионального общения

--------------------------------------------------------------------------------
ТРЕБОВАНИЯ
--------------------------------------------------------------------------------

+ Python 3.8+
+ Доступ к API Avito
+ API ключ OpenAI (GPT-4o-mini)
+ Telegram бот токен
+ Linux сервер (для продакшн развертывания)

Зависимости Python:
* aiohttp - для асинхронных HTTP запросов
* asyncio - для асинхронного программирования
* json - для работы с JSON данными
* datetime - для работы с временными метками

--------------------------------------------------------------------------------
БЫСТРЫЙ СТАРТ
--------------------------------------------------------------------------------

>>> Получение API ключей

Avito API:
  1. Зарегистрируйтеся в Avito API
  2. Получите CLIENT_ID и CLIENT_SECRET
  3. Узнайте свой USER_ID

OpenAI API:
  1. Зарегистрируйтесь на platform.openai.com
  2. Создайте API ключ с доступом к GPT-4

Telegram Bot:
  1. Создайте бота через @BotFather
  2. Получите токен бота
  3. Узнайте ID чата для уведомлений

>>> Локальная установка

$ git clone <repository-url>
$ cd avito-rental-bot
$ python3 -m venv venv
$ source venv/bin/activate
$ pip install aiohttp==3.9.1

>>> Настройка конфигурации

Отредактируйте файл config.py:

# API ключи
OPENAI_API_KEY = "ВАШ_АПИ_КЛЮЧ"
OPENAI_MODEL = "gpt-4o-mini"
AVITO_USER_ID = 000000000
AVITO_CLIENT_ID = "КЛИЕНТ_АЙДИ"
AVITO_CLIENT_SECRET = "СИКРЕТ_КЕЙ"
TELEGRAM_BOT_TOKEN = "ТОКЕН_БОТА"
TELEGRAM_CHAT_ID = "ЧАТ_АЙДИ"

# Настройки работы
CHECK_INTERVAL = 5  # интервал проверки в секундах
TIME_WINDOW_HOURS = 3  # окно времени для новых сообщений
MAX_MESSAGES_HISTORY = 30  # максимум сообщений для контекста GPT

>>> Запуск

$ python main.py

--------------------------------------------------------------------------------
РАЗВЕРТЫВАНИЕ НА СЕРВЕРЕ
--------------------------------------------------------------------------------

>>> Автоматическое развертывание

$ chmod +x deploy.sh
$ sudo ./deploy.sh

Скрипт deploy.sh выполняет:
- Установку системных зависимостей
- Создание пользователя avitobot
- Копирование файлов проекта в /opt/avito-rental-bot
- Настройку виртуального окружения Python
- Создание systemd сервиса
- Настройку логирования и ротации логов
- Создание скриптов управления

>>> После развертывания

Отредактируйте конфигурацию:
$ sudo nano /opt/avito-rental-bot/config.py

Запустите бота:
$ cd /opt/avito-rental-bot
$ ./start.sh

--------------------------------------------------------------------------------
КОМАНДЫ УПРАВЛЕНИЯ
--------------------------------------------------------------------------------

./start.sh          Запустить бота и добавить в автозагрузку
./stop.sh           Остановить бота
./restart.sh        Перезапустить бота
./status.sh         Показать статус и последние логи
./logs.sh           Просмотр логов в реальном времени

Системные команды:
$ sudo systemctl start avito-rental-bot     # Запуск
$ sudo systemctl stop avito-rental-bot      # Остановка
$ sudo systemctl restart avito-rental-bot   # Перезапуск
$ sudo systemctl status avito-rental-bot    # Статус
$ sudo systemctl enable avito-rental-bot    # Автозапуск

--------------------------------------------------------------------------------
МОНИТОРИНГ И ЛОГИ
--------------------------------------------------------------------------------

# Просмотр всех логов
$ sudo journalctl -u avito-rental-bot

# Логи в реальном времени
$ sudo journalctl -u avito-rental-bot -f

# Логи за последний час
$ sudo journalctl -u avito-rental-bot --since "1 hour ago"

# Последние 50 строк логов
$ sudo journalctl -u avito-rental-bot -n 50

Логи также сохраняются в:
/var/log/avito-rental-bot/ (с автоматической ротацией)

--------------------------------------------------------------------------------
НАСТРОЙКИ И ПРОМПТЫ
--------------------------------------------------------------------------------

Бот использует детализированную систему промптов из config.py:

SYSTEM_PROMPT - основной промпт для GPT с правилами общения
EXTRACTION_PROMPT_TEMPLATE - промпт для извлечения данных клиента
FIRST_MESSAGE_INSTRUCTION - инструкции для первого сообщения

Ключевые настройки:
- CHECK_INTERVAL: 5 секунд между проверками
- TIME_WINDOW_HOURS: 3 часа для новых сообщений
- MAX_MESSAGES_HISTORY: 30 сообщений в контексте GPT
- MIN_PHONE_DIGITS: минимум 10 цифр в номере телефона

--------------------------------------------------------------------------------
ЛОГИКА ДИАЛОГА
--------------------------------------------------------------------------------

Бот проходит через этапы сбора информации:
1. STAGE_GREETING - приветствие
2. STAGE_RESIDENTS - состав жильцов
3. STAGE_CHILDREN - информация о детях
4. STAGE_PETS - информация о животных
5. STAGE_RENTAL_PERIOD - срок аренды
6. STAGE_DEADLINE - дата заселения
7. STAGE_CONTACTS - контактные данные
8. STAGE_COMPLETE - завершение диалога

Маркер завершения: [COMPLETE] в ответе GPT

Финальные данные извлекаются в JSON формате и отправляются в Telegram.

--------------------------------------------------------------------------------
БЕЗОПАСНОСТЬ
--------------------------------------------------------------------------------

* Все API ключи хранятся в config.py
* Не публикуйте файл config.py с настоящими ключами
* Бот работает под пользователем avitobot (не root)
* Используются ограничения systemd для безопасности
* Автоматическая ротация логов предотвращает переполнение диска

--------------------------------------------------------------------------------
УСТРАНЕНИЕ НЕПОЛАДОК
--------------------------------------------------------------------------------

[!] Бот не запускается
    1. Проверьте правильность API ключей в config.py
    2. Убедитесь, что все зависимости установлены
    3. Проверьте логи: ./status.sh или ./logs.sh
    4. Проверьте права доступа к файлам

[!] Бот не отвечает на сообщения
    1. Проверьте правильность AVITO_USER_ID
    2. Убедитесь, что у вас есть активные объявления
    3. Проверьте доступ к OpenAI API
    4. Убедитесь, что сообщения не старше 3 часов

[!] Уведомления не приходят в Telegram
    1. Проверьте TELEGRAM_BOT_TOKEN и TELEGRAM_CHAT_ID
    2. Убедитесь, что бот добавлен в чат
    3. Проверьте права бота на отправку сообщений
    4. Проверьте, завершается ли диалог маркером [COMPLETE]

[!] GPT генерирует неправильные ответы
    1. Проверьте SYSTEM_PROMPT в config.py
    2. Убедитесь в корректности модели OPENAI_MODEL
    3. Проверьте историю диалога в логах
    4. Настройте параметры температуры генерации

[!] Высокое потребление ресурсов
    1. Увеличьте CHECK_INTERVAL для снижения частоты проверок
    2. Уменьшите MAX_MESSAGES_HISTORY для экономии памяти
    3. Проверьте количество активных чатов
    4. Мониторьте логи на предмет ошибок

--------------------------------------------------------------------------------
ФАЙЛОВАЯ СТРУКТУРА ПОСЛЕ РАЗВЕРТЫВАНИЯ
--------------------------------------------------------------------------------

/opt/avito-rental-bot/           # Основная директория проекта
├── main.py                      # Главный файл
├── avito.py                     # Модуль Avito API
├── chat_gpt.py                  # Модуль OpenAI
├── telegram.py                  # Модуль Telegram
├── config.py                    # Конфигурация
├── requirements.txt             # Python зависимости
├── venv/                        # Виртуальное окружение
├── start.sh                     # Скрипт запуска
├── stop.sh                      # Скрипт остановки
├── restart.sh                   # Скрипт перезапуска
├── status.sh                    # Скрипт статуса
└── logs.sh                      # Скрипт просмотра логов

/etc/systemd/system/avito-rental-bot.service    # Systemd сервис
/var/log/avito-rental-bot/                      # Директория логов
/etc/logrotate.d/avito-rental-bot               # Конфигурация ротации логов

--------------------------------------------------------------------------------
ТЕХНИЧЕСКАЯ ПОДДЕРЖКА
--------------------------------------------------------------------------------

При возникновении проблем:
1. Проверьте логи бота: ./logs.sh
2. Убедитесь в правильности конфигурации config.py
3. Проверьте доступность всех API
4. Убедитесь в корректности системного времени
5. Проверьте сетевое соединение сервера

Для отладки используйте:
- Детальные логи в /var/log/avito-rental-bot/
- Системные логи через journalctl
- Статус сервиса через systemctl status

================================================================================
Версия: 1.0 | Автор: ZerX | Дата: 04.08.2025
================================================================================